<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendations Wall - Cloud Storage Demo</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Recommendations Wall</h1>
            <p>Cloud Storage Demo: Each review = 1 JSON file in object storage!</p>
        </div>

        <div class="card">
            <h2>üéØ Top Tags Right Now</h2>
            <div class="stats" id="stats"></div>
        </div>

        <!-- ============================================
             CHART SECTION - Change style="display: none;" to style="display: none;"
             to reveal the chart during your live demo!
             ============================================ -->
        <div class="card" id="chartCard" style="display: block;">
            <h2>üìä Tag Visualization</h2>
            <canvas id="tagChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
            <h2>‚úçÔ∏è Add Your Recommendation</h2>
            <form id="reviewForm">
                <div class="form-group">
                    <label>What are you recommending? *</label>
                    <input type="text" id="title" placeholder="e.g., The Matrix, Chocolate Cake, Python" required>
                </div>
                <div class="form-group">
                    <label>Tag/Genre *</label>
                    <input type="text" id="tag" placeholder="e.g., Movie, Recipe, Language" required>
                </div>
                <div class="form-group">
                    <label>Rating *</label>
                    <div class="stars" id="stars">
                        <span class="star" data-value="1">‚òÖ</span>
                        <span class="star" data-value="2">‚òÖ</span>
                        <span class="star" data-value="3">‚òÖ</span>
                        <span class="star" data-value="4">‚òÖ</span>
                        <span class="star" data-value="5">‚òÖ</span>
                    </div>
                    <input type="hidden" id="rating" required>
                </div>
                <div class="form-group">
                    <label>Comment (optional)</label>
                    <textarea id="comment" placeholder="What did you like about it?"></textarea>
                </div>
                <button type="submit">Submit to Cloud ‚òÅÔ∏è</button>
                <div id="message"></div>
            </form>
        </div>

        <div class="card">
            <h2>üíæ Example: How Your Review is Stored</h2>
            <p>When you submit, the API creates a JSON file like this in Cloudflare R2:</p>
            <div class="example-json">
<span class="json-key">{
  "id"</span>: <span class="json-string">"a1b2c3d4-1234-5678-9abc-def012345678"</span>,
  <span class="json-key">"title"</span>: <span class="json-string">"The Matrix"</span>,
  <span class="json-key">"tag"</span>: <span class="json-string">"Movie"</span>,
  <span class="json-key">"stars"</span>: <span class="json-number">5</span>,
  <span class="json-key">"comment"</span>: <span class="json-string">"Mind-bending action!"</span>,
  <span class="json-key">"timestamp"</span>: <span class="json-string">"2025-11-11T14:30:00Z"</span>
}</div>
            <p class="storage-path">
                üìÅ Saved as: <code>reviews/a1b2c3d4-1234-5678-9abc-def012345678.json</code>
            </p>
        </div>

        <div class="card">
            <h2>üìñ Recent Reviews</h2>
            <div class="reviews-list" id="reviews"></div>
        </div>
    </div>

    <!-- Chart.js Library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        const API_URL = window.location.origin;
        let selectedRating = 0;
        let tagChart = null; // Store chart instance so we can update it

        // Star rating interaction
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.value);
                document.getElementById('rating').value = selectedRating;
                document.querySelectorAll('.star').forEach((s, i) => {
                    s.classList.toggle('active', i < selectedRating);
                });
            });
        });

        // ============================================
        // CHART FUNCTION: Create/Update Chart
        // Students: Try changing 'bar' to 'line', 'pie', or 'doughnut'!
        // ============================================
        function updateChart(topTags) {
            const ctx = document.getElementById('tagChart');
            
            // If no data yet, don't show chart
            if (!topTags || topTags.length === 0) {
                return;
            }
            
            // Extract data for the chart (top 8 tags)
            const labels = topTags.slice(0, 8).map(item => item.tag);
            const counts = topTags.slice(0, 8).map(item => item.count);
            const avgStars = topTags.slice(0, 8).map(item => item.avg_stars);
            
            // If chart already exists, update it instead of creating new one
            if (tagChart) {
                tagChart.data.labels = labels;
                tagChart.data.datasets[0].data = counts;
                tagChart.data.datasets[1].data = avgStars;
                tagChart.update();
                return;
            }
            
            // Create new chart
            tagChart = new Chart(ctx, {
                type: 'bar', // üé® TRY: Change to 'line', 'pie', 'doughnut', 'radar'
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '# of Reviews',
                            data: counts,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)', // üé® TRY: Change colors!
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Avg Stars',
                            data: avgStars,
                            backgroundColor: 'rgba(255, 193, 7, 0.8)', // üé® TRY: Change colors!
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Review Counts & Average Ratings by Tag',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Number of Reviews'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Average Stars'
                            },
                            min: 0,
                            max: 5,
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // Load stats, reviews, and UPDATE CHART
        // ============================================
        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/top`);
                const data = await response.json();
                
                // Update the chart with new data
                updateChart(data.top_tags);
                
                // Display stats
                const statsHtml = data.top_tags.slice(0, 4).map(item => `
                    <div class="stat-card">
                        <h3>${item.tag}</h3>
                        <div class="number">${item.count}</div>
                        <div>${'‚≠ê'.repeat(Math.round(item.avg_stars))}</div>
                    </div>
                `).join('');
                document.getElementById('stats').innerHTML = statsHtml || '<p>No recommendations yet!</p>';

                // Display recent reviews
                const reviewsHtml = data.recent_reviews.map(review => `
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-title">${review.title}</span>
                            <span class="review-tag">${review.tag}</span>
                        </div>
                        <div>${'‚≠ê'.repeat(review.stars)}</div>
                        ${review.comment ? `<p style="margin-top: 8px; color: #666;">${review.comment}</p>` : ''}
                    </div>
                `).join('');
                document.getElementById('reviews').innerHTML = reviewsHtml || '<p>Be the first to recommend something!</p>';
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Submit form
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('message');
            
            if (!selectedRating) {
                messageEl.innerHTML = '<div class="error">Please select a rating!</div>';
                return;
            }

            const review = {
                title: document.getElementById('title').value,
                tag: document.getElementById('tag').value,
                stars: selectedRating,
                comment: document.getElementById('comment').value || null
            };

            try {
                const response = await fetch(`${API_URL}/reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(review)
                });

                if (response.ok) {
                    messageEl.innerHTML = '<div class="success">‚úÖ Saved to cloud storage!</div>';
                    e.target.reset();
                    selectedRating = 0;
                    document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
                    setTimeout(() => loadData(), 500); // This will update the chart too!
                } else {
                    const error = await response.json();
                    messageEl.innerHTML = `<div class="error">‚ùå ${error.detail}</div>`;
                }
            } catch (error) {
                messageEl.innerHTML = '<div class="error">‚ùå Connection error</div>';
            }
        });

        // Load data on page load
        loadData();
        setInterval(loadData, 30000); // Refresh every 30 seconds (chart updates too!)
    </script>
</body>
</html>
